name: Auto Generate Index

on:
  push:
    paths:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/**'
  pull_request:
    paths:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-index:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate index.md
      run: |
        # Create the header for index.md
        cat > index.md << 'EOF'
        # Oqtane AI Playbook
        
        ![Oqtane](https://img.shields.io/badge/Oqtane-Framework-blue)
        ![AI Governance](https://img.shields.io/badge/AI-Governed-027%20Based--green)
        ![Canonical Source](https://img.shields.io/badge/Canonical-Oqtane%20Framework-black)
        
        > **This playbook aligns with the core principles of Oqtane as articulated in the Oqtane Philosophy â€” performance, flexibility, low ceremony, tool agnosticism, consistency, and practical engineering. See https://www.oqtane.org/blog/!/20/oqtane-philosophy for foundational context.**
        
        ---
        
        ## Overview
        
        The **Oqtane AI Playbook** is a framework-aware governance repository for building robust, upgrade-safe Oqtane modules - with or without AI assistance. This repository makes Oqtane's implicit rules explicit, enforceable, and visible to both humans and AI tools.
        
        **TL;DR for maintainers**: This repository defines **non-negotiable architectural and AI governance rules** for Oqtane module development. If AI-generated output conflicts with this playbook or the canonical module reference, **the output is invalid** regardless of correctness.
        
        ---
        
        ## ğŸ“‹ Auto-Generated Contents
        
        EOF
        
        # Add sections based on known file patterns
        echo "### ğŸ¯ Core Documentation" >> index.md
        echo "" >> index.md
        
        # Core docs
        for file in "000-preface.md" "001-problem.md" "002-insight.md" "003-scope-and-boundaries.md"; do
          if [ -f "docs/$file" ]; then
            title=$(head -n 1 "docs/$file" | sed 's/^# //')
            echo "- **[$title](docs/$file)**" >> index.md
          fi
        done
        
        echo "" >> index.md
        echo "### ğŸš€ Getting Started" >> index.md
        echo "" >> index.md
        
        # Getting started docs
        for file in "005-setup.md" "006-module-adoption.md" "00x-playbook-foundations.md"; do
          if [ -f "docs/$file" ]; then
            title=$(head -n 1 "docs/$file" | sed 's/^# //')
            echo "- **[$title](docs/$file)**" >> index.md
          fi
        done
        
        echo "" >> index.md
        echo "### ğŸ—ï¸ Architecture Guidelines" >> index.md
        echo "" >> index.md
        
        # Architecture docs
        for file in "010-services.md" "011-authorization.md" "012-migrations.md" "013-scheduled-jobs.md" "014-ui-validation.md" "015-Error-Handling.md" "016-logging.md" "017-Clien-Server-Responsibility- Boundaries.md" "018-service-registration.md" "019-Localization.md" "020-packaging-and-dependencies.md"; do
          if [ -f "docs/$file" ]; then
            title=$(head -n 1 "docs/$file" | sed 's/^# //')
            echo "- **[$title](docs/$file)**" >> index.md
          fi
        done
        
        echo "" >> index.md
        echo "### ğŸ”„ Migration and Updates" >> index.md
        echo "" >> index.md
        
        # Migration docs
        for file in "026-existing-projects.md"; do
          if [ -f "docs/$file" ]; then
            title=$(head -n 1 "docs/$file" | sed 's/^# //')
            echo "- **[$title](docs/$file)**" >> index.md
          fi
        done
        
        echo "" >> index.md
        echo "### ğŸ¤– AI Governance" >> index.md
        echo "" >> index.md
        
        # AI governance docs
        for file in "027-ai-governance.md" "028-repository-structure.md" "029-templates-and-stubs.md" "030-canonical-reference.md" "031-canonical-module-overview.md" "032-canonical-diff-policy.md" "034-canonical-verification-checklist.md"; do
          if [ -f "docs/$file" ]; then
            title=$(head -n 1 "docs/$file" | sed 's/^# //')
            echo "- **[$title](docs/$file)**" >> index.md
          fi
        done
        
        echo "" >> index.md
        echo "### âœ… Conclusion" >> index.md
        echo "" >> index.md
        
        # Conclusion docs
        for file in "100-conclusion.md"; do
          if [ -f "docs/$file" ]; then
            title=$(head -n 1 "docs/$file" | sed 's/^# //')
            echo "- **[$title](docs/$file)**" >> index.md
          fi
        done
        
        echo "" >> index.md
        echo "### ğŸ“š Additional Resources" >> index.md
        echo "" >> index.md
        
        # Additional resources (other .md files)
        for file in docs/*.md; do
          if [ -f "$file" ]; then
            basename=$(basename "$file")
            # Skip files already processed
            if [[ ! "$basename" =~ ^00[0-9].* ]]; then
              title=$(head -n 1 "$file" | sed 's/^# //')
              echo "- **[$title]($file)**" >> index.md
            fi
          fi
        done
        
        # Add key concepts section
        cat >> index.md << 'EOF'
        
        ---
        
        ## ğŸ”‘ Key Concepts
        
        ### Governance Model
        This repository follows a three-layer governance hierarchy:
        
        1. **Authoring Layer** - The Oqtane AI Playbook defines governance rules, patterns, and constraints
        2. **Reference Layer** - Playbook.Module.GovernedExample demonstrates implementation in practice  
        3. **Application Layer** - Real modules build features by following the example module
        
        ### Authority Order
        When conflicts arise, authority is resolved in this order:
        1. Canonical reference module
        2. Playbook documentation (`/docs`)
        3. Oqtane framework constraints
        4. AI-generated output (always last)
        
        ### Required Files for AI Governance
        When adopting this playbook, the following files must exist and be visible to AI tools:
        ```
        .github/
        â”œâ”€â”€ copilot-instructions.md
        
        docs/
        â”œâ”€â”€ governance/
        â”‚   â”œâ”€â”€ 027-rules-index.md
        â”‚   â””â”€â”€ 027x-*.md (rule files)
        â”œâ”€â”€ ai-decision-timeline.md
        â””â”€â”€ deviations.md
        ```
        
        ---
        
        ## ğŸ¤– Auto-Generation Info
        
        This `index.md` file is **automatically generated** by GitHub Actions whenever:
        - Files in the `docs/` directory change
        - Root markdown files change  
        - Workflow is manually triggered
        
        **âš ï¸ Do not manually edit this file** - your changes will be overwritten.
        
        To update the index, modify the source files or edit the workflow in `.github/workflows/auto-index.yml`.
        
        ---
        
        ## ğŸš¦ Quick Start
        
        1. **Read the documentation** - Start with the numbered narrative in `/docs`
        2. **Use as governance** - Reference in reviews and anchor AI tools to these rules
        3. **Adopt incrementally** - Apply to new code first, align old code when touched
        
        ---
        
        ## ğŸ›¡ï¸ Critical Rules
        
        - **Never reference this playbook directly in module code**
        - **Treat violations as hard failures, not suggestions**
        - **AI must follow documented Oqtane patterns exactly**
        - **Never introduce generic ASP.NET Core patterns without explicit reason**
        - **Always validate against the canonical reference module**
        
        ---
        
        ## â„¹ï¸ About
        
        This repository exists because most Oqtane module failures are caused by:
        - Generic .NET Core assumptions
        - Hidden framework invariants  
        - Multi-tenant misunderstandings
        - AI-generated code that looks right but violates Oqtane rules
        - Tribal knowledge that isn't written down
        
        By making these rules explicit and enforceable, AI becomes a productivity multiplier rather than a risk amplifier.
        
        ---
        
        ## ğŸ¤ Community
        
        Contributions are welcome in the form of:
        - Clarifications
        - Corrections  
        - Edge cases
        - Additional chapters
        - Real-world failures and lessons learned
        
        The goal is **shared understanding**, not personal ownership.
        
        ---
        
        *Frameworks don't fail. Tools don't fail. Developers don't fail. **Unspoken rules fail.***
        
        This repository exists to speak them out loud.
        EOF
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add index.md
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Auto-update index.md from docs [skip ci]"
          git push
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}