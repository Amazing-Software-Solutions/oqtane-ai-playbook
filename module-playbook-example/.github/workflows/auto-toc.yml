name: Auto Generate Navigation TOC (Module Example)

on:
  push:
    paths:
      - 'module-playbook-example/docs/**'
      - 'module-playbook-example/.github/**'
      - 'module-playbook-example/*.md'
  pull_request:
    paths:
      - 'module-playbook-example/docs/**'
      - 'module-playbook-example/.github/**'
      - 'module-playbook-example/*.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-toc:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate Navigation TOC
      run: |
        # Change to the module-playbook-example directory
        cd module-playbook-example
        
        # Create automated NAVIGATION.md
        cat > NAVIGATION.md << 'EOF'
        # Module Playbook Example - Auto-Generated Navigation

        > **ðŸ¤– This navigation file is automatically generated by GitHub Actions**
        > 
        > **Last updated:** $(date -u +"%Y-%m-%d %H:%M UTC")
        > 
        > **Trigger:** File changes in module-playbook-example/docs/, .github/, or root markdown files

        ---

        ## ðŸš€ Quick Navigation

        ### Core Documentation
        EOF
        
        # Add README if it exists
        if [ -f "README.md" ]; then
          echo "- **[Main README](README.md)** - $(head -n 3 README.md | tail -n 1 | sed 's/\*\*//g' | sed 's/^ *//')" >> NAVIGATION.md
        fi
        
        echo "" >> NAVIGATION.md
        echo "### ðŸ¤– AI Configuration" >> NAVIGATION.md
        
        # AI Configuration files
        if [ -f ".github/copilot-instructions.md" ]; then
          echo "- **[GitHub Copilot Instructions](.github/copilot-instructions.md)** - ðŸ¤– GitHub Copilot AI configuration" >> NAVIGATION.md
        fi
        
        if [ -f ".amazonq/rules/instructions.md" ]; then
          echo "- **[Amazon Q Instructions](.amazonq/rules/instructions.md)** - ðŸ¤– Amazon Q AI configuration" >> NAVIGATION.md
        fi
        
        echo "" >> NAVIGATION.md
        echo "---" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "## ðŸ“š Documentation Sections" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        
        # Governance Rules Section
        echo "### ðŸ›¡ï¸ Governance Rules (027x Series)" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        
        if [ -d "docs/governance" ]; then
          echo "#### Core Governance" >> NAVIGATION.md
          
          # Core governance files
          for file in "docs/governance/027-rules-index.md" "docs/governance/027x-core-ai-behavior.md" "docs/governance/027x-canonical-framework.md" "docs/governance/027x-canonical-validation.md" "docs/governance/027x-ai-instruction-discovery.md"; do
            if [ -f "$file" ]; then
              title=$(head -n 1 "$file" | sed 's/^# //')
              icon="ðŸ“‹"
              case "$file" in
                *"rules-index"*) icon="ðŸ”" ;;
                *"core-ai"*) icon="ðŸ¤–" ;;
                *"canonical-framework"*) icon="ðŸ—ï¸" ;;
                *"canonical-validation"*) icon="âœ…" ;;
                *"ai-instruction-discovery"*) icon="ðŸ”" ;;
              esac
              echo "- **[$title]($file)** - $icon ${title#* }" >> NAVIGATION.md
            fi
          done
          
          echo "" >> NAVIGATION.md
          echo "#### Development Patterns" >> NAVIGATION.md
          
          # Development pattern files
          for file in "docs/governance/027x-authorization.md" "docs/governance/027x-error-handling.md" "docs/governance/027x-localization.md" "docs/governance/027x-migrations.md" "docs/governance/027x-packaging-and-dependencies.md" "docs/governance/027x-repositories.md" "docs/governance/027x-scheduled-jobs.md" "docs/governance/027x-startup-and-service-registration.md" "docs/governance/027x-structure-and-boundaries.md"; do
            if [ -f "$file" ]; then
              title=$(head -n 1 "$file" | sed 's/^# //')
              icon="ðŸ“‹"
              case "$file" in
                *"authorization"*) icon="ðŸ”" ;;
                *"error-handling"*) icon="âš ï¸" ;;
                *"localization"*) icon="ðŸŒ" ;;
                *"migrations"*) icon="ðŸ”„" ;;
                *"packaging"*) icon="ðŸ“¦" ;;
                *"repositories"*) icon="ðŸ’¾" ;;
                *"scheduled-jobs"*) icon="â°" ;;
                *"startup"*) icon="ðŸš€" ;;
                *"structure-and-boundaries"*) icon="ðŸ›ï¸" ;;
              esac
              echo "- **[$title]($file)** - $icon ${title#* }" >> NAVIGATION.md
            fi
          done
          
          echo "" >> NAVIGATION.md
          echo "#### UI Development Rules" >> NAVIGATION.md
          
          # UI development files
          for file in "docs/governance/027x-ui-construction.md" "docs/governance/027x-ui-mudblazor.md" "docs/governance/027x-ui-Radzen.md" "docs/governance/027x-ui-validation.md"; do
            if [ -f "$file" ]; then
              title=$(head -n 1 "$file" | sed 's/^# //')
              icon="ðŸ“‹"
              case "$file" in
                *"ui-construction"*) icon="ðŸŽ¨" ;;
                *"ui-mudblazor"*) icon="ðŸ–Œï¸" ;;
                *"ui-Radzen"*) icon="ðŸŽ­" ;;
                *"ui-validation"*) icon="âœ…" ;;
              esac
              echo "- **[$title]($file)** - $icon ${title#* }" >> NAVIGATION.md
            fi
          done
        fi
        
        echo "" >> NAVIGATION.md
        echo "---" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "### ðŸŽ¯ AI Development Prompts" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        
        if [ -d "docs/prompts" ]; then
          echo "#### Specialized Prompts" >> NAVIGATION.md
          
          # Prompt files
          for file in "docs/prompts/Authorization.md" "docs/prompts/diagnositics.md" "docs/prompts/Localization Opt-In.md" "docs/prompts/services.md" "docs/prompts/UI Construction Prompt.md" "docs/prompts/ui.md"; do
            if [ -f "$file" ]; then
              title=$(head -n 1 "$file" | sed 's/^# //')
              icon="ðŸ’¬"
              case "$file" in
                *"Authorization"*) icon="ðŸ”" ;;
                *"diagnositics"*) icon="ðŸ”" ;;
                *"Localization"*) icon="ðŸŒ" ;;
                *"services"*) icon="âš™ï¸" ;;
                *"UI Construction"*) icon="ðŸŽ¨" ;;
                *"ui.md"*) icon="ðŸ–¼ï¸" ;;
              esac
              echo "- **[$title]($file)** - $icon ${title#* }" >> NAVIGATION.md
            fi
          done
          
          # Prompts README
          if [ -f "docs/prompts/README.md" ]; then
            title=$(head -n 1 "docs/prompts/README.md" | sed 's/^# //')
            echo "- **[$title](docs/prompts/README.md)** - ðŸ“– Overview of AI prompts collection" >> NAVIGATION.md
          fi
        fi
        
        echo "" >> NAVIGATION.md
        echo "---" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "### ðŸ“Š Governance Documentation" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        
        echo "#### Governance Records" >> NAVIGATION.md
        
        # Governance documentation files
        for file in "docs/ai-decision-timeline.md" "docs/deviations.md"; do
          if [ -f "$file" ]; then
            title=$(head -n 1 "$file" | sed 's/^# //')
            icon="ðŸ“‹"
            case "$file" in
              *"ai-decision-timeline"*) icon="ðŸ“œ" ;;
              *"deviations"*) icon="âš ï¸" ;;
            esac
            echo "- **[$title]($file)** - $icon ${title#* }" >> NAVIGATION.md
          fi
        done
        
        # Governance README
        if [ -f "docs/governance/README.md" ]; then
          title=$(head -n 1 "docs/governance/README.md" | sed 's/^# //')
          echo "- **[$title](docs/governance/README.md)** - ðŸ“‹ Overview of governance documentation" >> NAVIGATION.md
        fi
        
        echo "" >> NAVIGATION.md
        echo "---" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "## ðŸ“ˆ Repository Statistics" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        
        # Generate statistics
        total_files=$(find . -name "*.md" -type f | wc -l)
        governance_files=$(find docs/governance -name "*.md" -type f 2>/dev/null | wc -l)
        prompt_files=$(find docs/prompts -name "*.md" -type f 2>/dev/null | wc -l)
        
        echo "- **ðŸ“„ Total Markdown Files:** $total_files" >> NAVIGATION.md
        echo "- **ðŸ›¡ï¸ Governance Rules:** $governance_files" >> NAVIGATION.md
        echo "- **ðŸŽ¯ AI Prompts:** $prompt_files" >> NAVIGATION.md
        echo "- **ðŸ¤– AI Config Files:** $(find .github .amazonq -name "*.md" -type f 2>/dev/null | wc -l)" >> NAVIGATION.md
        
        echo "" >> NAVIGATION.md
        echo "---" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "## ðŸ”‘ Quick Reference" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        
        # File organization tree
        echo '```' >> NAVIGATION.md
        echo "module-playbook-example/" >> NAVIGATION.md
        echo "â”œâ”€â”€ README.md                           # ðŸ“– Project overview" >> NAVIGATION.md
        echo "â”œâ”€â”€ .github/copilot-instructions.md     # ðŸ¤– GitHub Copilot AI config" >> NAVIGATION.md
        echo "â”œâ”€â”€ .amazonq/rules/instructions.md      # ðŸ¤– Amazon Q AI config" >> NAVIGATION.md
        echo "â”œâ”€â”€ docs/" >> NAVIGATION.md
        echo "â”‚   â”œâ”€â”€ governance/                     # ðŸ›¡ï¸ 027x governance rules" >> NAVIGATION.md
        echo "â”‚   â”‚   â”œâ”€â”€ 027-rules-index.md         # ðŸ“‹ Rules index" >> NAVIGATION.md
        echo "â”‚   â”‚   â”œâ”€â”€ 027x-*.md                   # ðŸ“œ Individual rules" >> NAVIGATION.md
        echo "â”‚   â”‚   â””â”€â”€ README.md                   # ðŸ“– Governance overview" >> NAVIGATION.md
        echo "â”‚   â”œâ”€â”€ prompts/                        # ðŸŽ¯ AI development prompts" >> NAVIGATION.md
        echo "â”‚   â”‚   â”œâ”€â”€ *.md                        # ðŸ’¬ Specific prompts" >> NAVIGATION.md
        echo "â”‚   â”‚   â””â”€â”€ README.md                   # ðŸ“– Prompts overview" >> NAVIGATION.md
        echo "â”‚   â”œâ”€â”€ ai-decision-timeline.md        # ðŸ“œ Decision history" >> NAVIGATION.md
        echo "â”‚   â””â”€â”€ deviations.md                   # âš ï¸ Pattern deviations" >> NAVIGATION.md
        echo "â”œâ”€â”€ NAVIGATION.md                       # ðŸ—ºï¸ This auto-generated navigation" >> NAVIGATION.md
        echo "â””â”€â”€ toc.yml                             # ðŸ“Š Structured TOC data" >> NAVIGATION.md
        echo '```' >> NAVIGATION.md
        
        echo "" >> NAVIGATION.md
        echo "---" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "## ðŸ¤– Automation Information" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "This navigation file is **automatically generated** by GitHub Actions:" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "- **Trigger:** Changes in \`module-playbook-example/docs/\`, \`.github/\`, or root \`.md\` files" >> NAVIGATION.md
        echo "- **Frequency:** On every relevant push/PR" >> NAVIGATION.md
        echo "- **Manual Trigger:** Available via GitHub Actions tab" >> NAVIGATION.md
        echo "- **Source:** Workflow in \`module-playbook-example/.github/workflows/auto-toc.yml\`" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "**âš ï¸ Do not manually edit this file** - your changes will be overwritten." >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "To update the navigation:" >> NAVIGATION.md
        echo "1. Add/remove/update files in the source directories" >> NAVIGATION.md
        echo "2. Commit and push changes" >> NAVIGATION.md
        echo "3. Navigation will update automatically" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "---" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "## ðŸ”— Related Resources" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "- **[Oqtane AI Playbook](../README.md)** - ðŸ“š Parent playbook repository" >> NAVIGATION.md
        echo "- **[Framework Documentation](https://www.oqtane.org)** - ðŸŒ Official Oqtane docs" >> NAVIGATION.md
        echo "- **[Application Example](https://github.com/leigh-pointer/Playbook.Module.GovernedExample)** - ðŸš€ Real governed module implementation" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "---" >> NAVIGATION.md
        echo "" >> NAVIGATION.md
        echo "*ðŸ¤– This navigation is automatically maintained to always reflect the current state of the repository*" >> NAVIGATION.md
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add module-playbook-example/NAVIGATION.md
        if git diff --staged --quiet; then
          echo "No changes to NAVIGATION.md - it's already up to date"
        else
          git commit -m "Auto-update module-playbook-example/NAVIGATION.md [skip ci]"
          git push
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}